{% extends 'base.html' %}
{% block title %}Transações Públicas · Tucupi Labs{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <!-- Header -->
    <div class="mb-8 animate-slide-up">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-4xl font-display font-bold text-gradient mb-2">Transações Recentes</h1>
                <p class="text-gray-400">Atividade em tempo real do marketplace de créditos de carbono</p>
            </div>
            <!-- Indicador de Status de Conexão -->
            <div id="connection-status" class="flex items-center gap-2 px-4 py-2 glass rounded-lg border">
                <div id="status-dot" class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"></div>
                <span id="status-text" class="text-sm font-medium text-yellow-400">Conectando...</span>
            </div>
        </div>
        <div class="glass rounded-xl p-4 border border-white/10">
            <p class="text-sm text-gray-400">
                <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                Todas as informações dos participantes são anonimizadas. Apenas funções e detalhes das transações são exibidos.
            </p>
        </div>
    </div>

    <!-- Tabela de Transações -->
    <div class="glass rounded-2xl overflow-hidden border border-white/10 animate-slide-up" style="animation-delay: 0.1s;">
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="border-b border-white/10">
                        <th class="px-6 py-4 text-left text-xs font-bold text-tucupi-green-400 uppercase tracking-wider">Horário</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-tucupi-green-400 uppercase tracking-wider">Transferência</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-tucupi-green-400 uppercase tracking-wider">Quantidade</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-tucupi-green-400 uppercase tracking-wider">Preço</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-tucupi-green-400 uppercase tracking-wider">Origem</th>
                    </tr>
                </thead>
                <tbody id="transactions-table" class="divide-y divide-white/5">
                    {% for tx in transactions %}
                        <tr class="hover:bg-white/5 transition" data-tx-id="{{ tx.id }}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                <time class="relative-time" datetime="{{ tx.timestamp.isoformat }}">
                                    {{ tx.timestamp|date:"d/m/Y H:i" }}
                                </time>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <div class="flex items-center gap-2">
                                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-blue-500/20 text-blue-400 border border-blue-500/50 text-xs font-bold">
                                        {{ tx.buyer.get_role_display }}
                                    </span>
                                    <i data-lucide="arrow-left" class="w-4 h-4 text-gray-500"></i>
                                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-green-500/20 text-green-400 border border-green-500/50 text-xs font-bold">
                                        {{ tx.seller.get_role_display }}
                                    </span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-white">
                                {{ tx.amount }} tCO₂
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-tucupi-accent">
                                R$ {{ tx.total_price|floatformat:2 }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                                {{ tx.credit.origin }}
                            </td>
                        </tr>
                    {% empty %}
                        <tr id="no-transactions-row">
                            <td colspan="5" class="px-6 py-12 text-center">
                                <div class="text-gray-500">
                                    <i data-lucide="activity" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                                    <p class="text-sm">Nenhuma transação concluída ainda</p>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Cards Informativos -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6 animate-slide-up" style="animation-delay: 0.2s;">
        <div class="glass rounded-xl p-6 border border-tucupi-green-500/30">
            <div class="flex items-center gap-3 mb-2">
                <i data-lucide="zap" class="w-6 h-6 text-tucupi-green-400"></i>
                <h3 class="font-bold text-white">Atualizações em Tempo Real</h3>
            </div>
            <p class="text-sm text-gray-400">Transações aparecem automaticamente ao serem concluídas</p>
        </div>
        <div class="glass rounded-xl p-6 border border-blue-500/30">
            <div class="flex items-center gap-3 mb-2">
                <i data-lucide="shield" class="w-6 h-6 text-blue-400"></i>
                <h3 class="font-bold text-white">Privacidade Protegida</h3>
            </div>
            <p class="text-sm text-gray-400">Nenhuma informação pessoal é exibida publicamente</p>
        </div>
        <div class="glass rounded-xl p-6 border border-purple-500/30">
            <div class="flex items-center gap-3 mb-2">
                <i data-lucide="eye" class="w-6 h-6 text-purple-400"></i>
                <h3 class="font-bold text-white">Transparente</h3>
            </div>
            <p class="text-sm text-gray-400">Últimas 10 transações concluídas exibidas</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // SSE Connection Management
    let eventSource = null;
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const transactionsTable = document.getElementById('transactions-table');
    const MAX_TRANSACTIONS = 10;

    function updateConnectionStatus(status) {
        if (status === 'connected') {
            statusDot.className = 'w-3 h-3 rounded-full bg-tucupi-green-500';
            statusText.textContent = 'Ao Vivo';
            statusText.className = 'text-sm font-medium text-tucupi-green-400';
        } else if (status === 'connecting') {
            statusDot.className = 'w-3 h-3 rounded-full bg-yellow-500 animate-pulse';
            statusText.textContent = 'Conectando...';
            statusText.className = 'text-sm font-medium text-yellow-400';
        } else {
            statusDot.className = 'w-3 h-3 rounded-full bg-red-500';
            statusText.textContent = 'Desconectado';
            statusText.className = 'text-sm font-medium text-red-400';
        }
    }

    function formatRelativeTime(isoTimestamp) {
        const date = new Date(isoTimestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Agora mesmo';
        if (diffMins === 1) return '1 min atrás';
        if (diffMins < 60) return `${diffMins} mins atrás`;
        if (diffHours === 1) return '1 hora atrás';
        if (diffHours < 24) return `${diffHours} horas atrás`;
        if (diffDays === 1) return '1 dia atrás';
        return `${diffDays} dias atrás`;
    }

    function updateRelativeTimes() {
        document.querySelectorAll('.relative-time').forEach(el => {
            const datetime = el.getAttribute('datetime');
            if (datetime) {
                el.textContent = formatRelativeTime(datetime);
            }
        });
    }

    function addTransaction(txData) {
        // Remove linha "nenhuma transação" se existir
        const noTxRow = document.getElementById('no-transactions-row');
        if (noTxRow) {
            noTxRow.remove();
        }

        // Verifica se transação já existe
        if (document.querySelector(`tr[data-tx-id="${txData.id}"]`)) {
            return;
        }

        // Cria nova linha
        const row = document.createElement('tr');
        row.className = 'hover:bg-white/5 transition animate-slide-down';
        row.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
        row.setAttribute('data-tx-id', txData.id);

        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                <time class="relative-time" datetime="${txData.timestamp}">
                    ${formatRelativeTime(txData.timestamp)}
                </time>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
                <div class="flex items-center gap-2">
                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-blue-500/20 text-blue-400 border border-blue-500/50 text-xs font-bold">
                        ${txData.buyer_role}
                    </span>
                    <i data-lucide="arrow-left" class="w-4 h-4 text-gray-500"></i>
                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-green-500/20 text-green-400 border border-green-500/50 text-xs font-bold">
                        ${txData.seller_role}
                    </span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-white">
                ${txData.amount} tCO₂
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-tucupi-accent">
                R$ ${parseFloat(txData.total_price).toFixed(2)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                ${txData.credit_origin}
            </td>
        `;

        // Adiciona no início da tabela (mais recente primeiro)
        transactionsTable.insertBefore(row, transactionsTable.firstChild);

        // Reinicializa ícones Lucide para a nova linha
        lucide.createIcons();

        // Remove destaque após 2 segundos
        setTimeout(() => {
            row.style.backgroundColor = '';
        }, 2000);

        // Mantém apenas MAX_TRANSACTIONS linhas
        const rows = transactionsTable.querySelectorAll('tr');
        if (rows.length > MAX_TRANSACTIONS) {
            for (let i = MAX_TRANSACTIONS; i < rows.length; i++) {
                rows[i].remove();
            }
        }
    }

    function getStoredSessionId() {
        const stored = localStorage.getItem('sse_session');
        if (!stored) return null;

        try {
            const session = JSON.parse(stored);
            // Verifica se sessão ainda é válida (dentro de 60s)
            const now = Date.now();
            if (now - session.timestamp > 60000) {
                // Sessão expirada, limpar
                localStorage.removeItem('sse_session');
                return null;
            }
            return session.id;
        } catch (e) {
            localStorage.removeItem('sse_session');
            return null;
        }
    }

    function storeSessionId(sessionId) {
        const session = {
            id: sessionId,
            timestamp: Date.now()
        };
        localStorage.setItem('sse_session', JSON.stringify(session));
    }

    function updateSessionTimestamp() {
        const stored = localStorage.getItem('sse_session');
        if (stored) {
            try {
                const session = JSON.parse(stored);
                session.timestamp = Date.now();
                localStorage.setItem('sse_session', JSON.stringify(session));
            } catch (e) {
                // Ignora erros
            }
        }
    }

    function connectSSE() {
        updateConnectionStatus('connecting');

        // Tenta usar ID de sessão existente para reconexão
        const sessionId = getStoredSessionId();
        const url = sessionId
            ? '{% url "transactions:public_transactions_sse" %}?session_id=' + sessionId
            : '{% url "transactions:public_transactions_sse" %}';

        eventSource = new EventSource(url);

        eventSource.onopen = function() {
            console.log('Conexão SSE estabelecida');
            updateConnectionStatus('connected');
        };

        // Processa evento de sessão (enviado em nova conexão)
        eventSource.addEventListener('session', function(event) {
            try {
                const data = JSON.parse(event.data);
                console.log('ID de sessão recebido:', data.session_id);
                storeSessionId(data.session_id);
            } catch (error) {
                console.error('Erro ao analisar dados da sessão:', error);
            }
        });

        // Processa eventos de dados de transação
        eventSource.onmessage = function(event) {
            try {
                const txData = JSON.parse(event.data);
                console.log('Nova transação:', txData);
                addTransaction(txData);
            } catch (error) {
                console.error('Erro ao analisar dados da transação:', error);
            }
        };

        eventSource.onerror = function(error) {
            console.error('Erro SSE:', error);
            updateConnectionStatus('disconnected');
            eventSource.close();

            // Tenta reconectar após 3 segundos
            // ID de sessão no localStorage permite ignorar rate limit
            setTimeout(() => {
                console.log('Tentando reconectar...');
                connectSSE();
            }, 3000);
        };
    }

    // Inicializa ao carregar a página
    document.addEventListener('DOMContentLoaded', function() {
        connectSSE();

        // Atualiza timestamps relativos a cada minuto
        setInterval(updateRelativeTimes, 60000);

        // Atualiza timestamp da sessão a cada 10 segundos para mantê-la ativa
        setInterval(updateSessionTimestamp, 10000);

        // Atualização inicial de timestamps relativos
        updateRelativeTimes();
    });

    // Detecta visibilidade da página para limpar sessão quando usuário sai
    let isPageVisible = !document.hidden;
    document.addEventListener('visibilitychange', function() {
        isPageVisible = !document.hidden;
    });

    // Limpeza ao descarregar a página
    window.addEventListener('beforeunload', function() {
        if (eventSource) {
            eventSource.close();
        }

        // Se usuário está saindo (não apenas atualizando), limpa sessão após delay
        // Isso dá tempo para atualização da página completar
        if (!isPageVisible) {
            setTimeout(() => {
                localStorage.removeItem('sse_session');
            }, 2000);
        }
    });
</script>
{% endblock %}

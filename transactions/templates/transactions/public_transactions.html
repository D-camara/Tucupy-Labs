{% extends 'base.html' %}
{% block title %}Transa√ß√µes P√∫blicas ¬∑ Tucupi Labs{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <!-- Header -->
    <div class="mb-8 animate-slide-up">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-500/20 to-purple-600/20 rounded-xl flex items-center justify-center border border-blue-500/30">
                    <i data-lucide="eye" class="w-6 h-6 text-blue-400"></i>
                </div>
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <h1 class="text-4xl font-display font-bold text-gradient">Transa√ß√µes P√∫blicas</h1>
                        <span class="px-3 py-1 bg-blue-500/20 text-blue-400 text-xs font-bold rounded-full border border-blue-500/50">AO VIVO</span>
                    </div>
                    <p class="text-gray-400">Monitor de atividade em tempo real ¬∑ Dados anonimizados</p>
                </div>
            </div>
            <!-- Indicador de Status de Conex√£o -->
            <div id="connection-status" class="flex items-center gap-2 px-4 py-2 glass rounded-lg border">
                <div id="status-dot" class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"></div>
                <span id="status-text" class="text-sm font-medium text-yellow-400">Conectando...</span>
            </div>
        </div>
        <div class="glass rounded-xl p-4 border border-blue-500/30 bg-blue-500/5">
            <div class="flex items-start gap-3">
                <i data-lucide="shield-check" class="w-5 h-5 text-blue-400 mt-0.5 flex-shrink-0"></i>
                <div>
                    <p class="text-sm font-semibold text-blue-400 mb-1">üîí Informa√ß√µes Protegidas</p>
                    <p class="text-sm text-gray-400">
                        Nomes de usu√°rios, fazendas e dados pessoais <strong>n√£o s√£o exibidos publicamente</strong>. 
                        Apenas tipos de participantes (Produtor/Empresa) e valores das transa√ß√µes s√£o mostrados para transpar√™ncia do mercado.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Transa√ß√µes -->
    <div class="glass rounded-2xl overflow-hidden border border-white/10 animate-slide-up" style="animation-delay: 0.1s;">
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="border-b border-white/10">
                        <th class="px-6 py-4 text-left text-xs font-bold text-tucupi-green-400 uppercase tracking-wider">Hor√°rio</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-tucupi-green-400 uppercase tracking-wider">Transfer√™ncia</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-tucupi-green-400 uppercase tracking-wider">Quantidade</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-tucupi-green-400 uppercase tracking-wider">Valor Total</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-tucupi-green-400 uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody id="transactions-table" class="divide-y divide-white/5">
                    {% for tx in transactions %}
                        <tr class="hover:bg-white/5 transition" data-tx-id="{{ tx.id }}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                <time class="relative-time" datetime="{{ tx.timestamp.isoformat }}">
                                    {{ tx.timestamp|date:"d/m/Y H:i" }}
                                </time>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <div class="flex items-center gap-2">
                                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-blue-500/20 text-blue-400 border border-blue-500/50 text-xs font-bold">
                                        {{ tx.buyer.get_role_display }}
                                    </span>
                                    <i data-lucide="arrow-left" class="w-4 h-4 text-gray-500"></i>
                                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-green-500/20 text-green-400 border border-green-500/50 text-xs font-bold">
                                        {{ tx.seller.get_role_display }}
                                    </span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-white">
                                {{ tx.amount }} tCO‚ÇÇ
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-tucupi-accent">
                                R$ {{ tx.total_price|floatformat:2 }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-green-500/20 text-green-400 border border-green-500/50 text-xs font-bold">
                                    <i data-lucide="check-circle" class="w-3.5 h-3.5"></i>
                                    CONCLU√çDA
                                </span>
                            </td>
                        </tr>
                    {% empty %}
                        <tr id="no-transactions-row">
                            <td colspan="5" class="px-6 py-12 text-center">
                                <div class="text-gray-500">
                                    <i data-lucide="activity" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                                    <p class="font-semibold mb-1">Nenhuma transa√ß√£o p√∫blica dispon√≠vel</p>
                                    <p class="text-xs text-gray-600">Aguardando novas transa√ß√µes conclu√≠das...</p>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Cards Informativos -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6 animate-slide-up" style="animation-delay: 0.2s;">
        <div class="glass rounded-xl p-6 border border-tucupi-green-500/30">
            <div class="flex items-center gap-3 mb-2">
                <i data-lucide="zap" class="w-6 h-6 text-tucupi-green-400"></i>
                <h3 class="font-bold text-white">Atualiza√ß√µes Instant√¢neas</h3>
            </div>
            <p class="text-sm text-gray-400">Transa√ß√µes aparecem automaticamente sem recarregar a p√°gina</p>
        </div>
        <div class="glass rounded-xl p-6 border border-blue-500/30">
            <div class="flex items-center gap-3 mb-2">
                <i data-lucide="shield-check" class="w-6 h-6 text-blue-400"></i>
                <h3 class="font-bold text-white">100% Anonimizado</h3>
            </div>
            <p class="text-sm text-gray-400">Nomes, fazendas e dados pessoais <strong>n√£o aparecem</strong></p>
        </div>
        <div class="glass rounded-xl p-6 border border-purple-500/30">
            <div class="flex items-center gap-3 mb-2">
                <i data-lucide="clock" class="w-6 h-6 text-purple-400"></i>
                <h3 class="font-bold text-white">√öltimas 10 Transa√ß√µes</h3>
            </div>
            <p class="text-sm text-gray-400">Hist√≥rico p√∫blico das transa√ß√µes mais recentes conclu√≠das</p>
        </div>
    </div>
    
    <!-- Diferen√ßa para usu√°rios logados -->
    {% if not user.is_authenticated %}
    <div class="mt-6 glass rounded-xl p-6 border border-yellow-500/30 bg-yellow-500/5 animate-slide-up" style="animation-delay: 0.3s;">
        <div class="flex items-start gap-4">
            <div class="w-10 h-10 bg-yellow-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                <i data-lucide="user-plus" class="w-5 h-5 text-yellow-400"></i>
            </div>
            <div class="flex-1">
                <h3 class="font-bold text-white mb-2 flex items-center gap-2">
                    üí° Quer ver suas pr√≥prias transa√ß√µes com detalhes completos?
                </h3>
                <p class="text-sm text-gray-400 mb-4">
                    Usu√°rios <strong>logados</strong> t√™m acesso a uma √°rea completa com todas as suas transa√ß√µes, 
                    incluindo nomes, valores detalhados, documentos e hist√≥rico completo de transfer√™ncias.
                </p>
                <div class="flex gap-3">
                    <a href="{% url 'accounts:login' %}" class="inline-flex items-center gap-2 px-4 py-2 bg-tucupi-green-500 hover:bg-tucupi-green-600 text-white rounded-lg font-semibold transition">
                        <i data-lucide="log-in" class="w-4 h-4"></i>
                        Fazer Login
                    </a>
                    <a href="{% url 'accounts:register' %}" class="inline-flex items-center gap-2 px-4 py-2 glass hover:bg-white/10 text-gray-300 rounded-lg font-semibold transition border border-white/20">
                        <i data-lucide="user-plus" class="w-4 h-4"></i>
                        Criar Conta
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // SSE Connection Management
    let eventSource = null;
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const transactionsTable = document.getElementById('transactions-table');
    const MAX_TRANSACTIONS = 10;

    function updateConnectionStatus(status) {
        if (status === 'connected') {
            statusDot.className = 'w-3 h-3 rounded-full bg-tucupi-green-500';
            statusText.textContent = 'Ao Vivo';
            statusText.className = 'text-sm font-medium text-tucupi-green-400';
        } else if (status === 'connecting') {
            statusDot.className = 'w-3 h-3 rounded-full bg-yellow-500 animate-pulse';
            statusText.textContent = 'Conectando...';
            statusText.className = 'text-sm font-medium text-yellow-400';
        } else {
            statusDot.className = 'w-3 h-3 rounded-full bg-red-500';
            statusText.textContent = 'Desconectado';
            statusText.className = 'text-sm font-medium text-red-400';
        }
    }

    function formatRelativeTime(isoTimestamp) {
        const date = new Date(isoTimestamp);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Agora mesmo';
        if (diffMins === 1) return '1 min atr√°s';
        if (diffMins < 60) return `${diffMins} mins atr√°s`;
        if (diffHours === 1) return '1 hora atr√°s';
        if (diffHours < 24) return `${diffHours} horas atr√°s`;
        if (diffDays === 1) return '1 dia atr√°s';
        return `${diffDays} dias atr√°s`;
    }

    function updateRelativeTimes() {
        document.querySelectorAll('.relative-time').forEach(el => {
            const datetime = el.getAttribute('datetime');
            if (datetime) {
                el.textContent = formatRelativeTime(datetime);
            }
        });
    }

    function addTransaction(txData) {
        // Remove linha "nenhuma transa√ß√£o" se existir
        const noTxRow = document.getElementById('no-transactions-row');
        if (noTxRow) {
            noTxRow.remove();
        }

        // Verifica se transa√ß√£o j√° existe
        if (document.querySelector(`tr[data-tx-id="${txData.id}"]`)) {
            return;
        }

        // Cria nova linha
        const row = document.createElement('tr');
        row.className = 'hover:bg-white/5 transition animate-slide-down';
        row.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
        row.setAttribute('data-tx-id', txData.id);

        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                <time class="relative-time" datetime="${txData.timestamp}">
                    ${formatRelativeTime(txData.timestamp)}
                </time>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
                <div class="flex items-center gap-2">
                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-blue-500/20 text-blue-400 border border-blue-500/50 text-xs font-bold">
                        ${txData.buyer_role}
                    </span>
                    <i data-lucide="arrow-left" class="w-4 h-4 text-gray-500"></i>
                    <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-green-500/20 text-green-400 border border-green-500/50 text-xs font-bold">
                        ${txData.seller_role}
                    </span>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-white">
                ${txData.amount} tCO‚ÇÇ
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-tucupi-accent">
                R$ ${parseFloat(txData.total_price).toFixed(2)}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full bg-green-500/20 text-green-400 border border-green-500/50 text-xs font-bold">
                    <i data-lucide="check-circle" class="w-3.5 h-3.5"></i>
                    CONCLU√çDA
                </span>
            </td>
        `;

        // Adiciona no in√≠cio da tabela (mais recente primeiro)
        transactionsTable.insertBefore(row, transactionsTable.firstChild);

        // Reinicializa √≠cones Lucide para a nova linha
        lucide.createIcons();

        // Remove destaque ap√≥s 2 segundos
        setTimeout(() => {
            row.style.backgroundColor = '';
        }, 2000);

        // Mant√©m apenas MAX_TRANSACTIONS linhas
        const rows = transactionsTable.querySelectorAll('tr');
        if (rows.length > MAX_TRANSACTIONS) {
            for (let i = MAX_TRANSACTIONS; i < rows.length; i++) {
                rows[i].remove();
            }
        }
    }

    function getStoredSessionId() {
        const stored = localStorage.getItem('sse_session');
        if (!stored) return null;

        try {
            const session = JSON.parse(stored);
            // Verifica se sess√£o ainda √© v√°lida (dentro de 60s)
            const now = Date.now();
            if (now - session.timestamp > 60000) {
                // Sess√£o expirada, limpar
                localStorage.removeItem('sse_session');
                return null;
            }
            return session.id;
        } catch (e) {
            localStorage.removeItem('sse_session');
            return null;
        }
    }

    function storeSessionId(sessionId) {
        const session = {
            id: sessionId,
            timestamp: Date.now()
        };
        localStorage.setItem('sse_session', JSON.stringify(session));
    }

    function updateSessionTimestamp() {
        const stored = localStorage.getItem('sse_session');
        if (stored) {
            try {
                const session = JSON.parse(stored);
                session.timestamp = Date.now();
                localStorage.setItem('sse_session', JSON.stringify(session));
            } catch (e) {
                // Ignora erros
            }
        }
    }

    function connectSSE() {
        updateConnectionStatus('connecting');

        // Tenta usar ID de sess√£o existente para reconex√£o
        const sessionId = getStoredSessionId();
        const url = sessionId
            ? '{% url "transactions:public_transactions_sse" %}?session_id=' + sessionId
            : '{% url "transactions:public_transactions_sse" %}';

        eventSource = new EventSource(url);

        eventSource.onopen = function() {
            console.log('Conex√£o SSE estabelecida');
            updateConnectionStatus('connected');
        };

        // Processa evento de sess√£o (enviado em nova conex√£o)
        eventSource.addEventListener('session', function(event) {
            try {
                const data = JSON.parse(event.data);
                console.log('ID de sess√£o recebido:', data.session_id);
                storeSessionId(data.session_id);
            } catch (error) {
                console.error('Erro ao analisar dados da sess√£o:', error);
            }
        });

        // Processa eventos de dados de transa√ß√£o
        eventSource.onmessage = function(event) {
            try {
                const txData = JSON.parse(event.data);
                console.log('Nova transa√ß√£o:', txData);
                addTransaction(txData);
            } catch (error) {
                console.error('Erro ao analisar dados da transa√ß√£o:', error);
            }
        };

        eventSource.onerror = function(error) {
            console.error('Erro SSE:', error);
            updateConnectionStatus('disconnected');
            eventSource.close();

            // Tenta reconectar ap√≥s 3 segundos
            // ID de sess√£o no localStorage permite ignorar rate limit
            setTimeout(() => {
                console.log('Tentando reconectar...');
                connectSSE();
            }, 3000);
        };
    }

    // Inicializa ao carregar a p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        connectSSE();

        // Atualiza timestamps relativos a cada minuto
        setInterval(updateRelativeTimes, 60000);

        // Atualiza timestamp da sess√£o a cada 10 segundos para mant√™-la ativa
        setInterval(updateSessionTimestamp, 10000);

        // Atualiza√ß√£o inicial de timestamps relativos
        updateRelativeTimes();
    });

    // Detecta visibilidade da p√°gina para limpar sess√£o quando usu√°rio sai
    let isPageVisible = !document.hidden;
    document.addEventListener('visibilitychange', function() {
        isPageVisible = !document.hidden;
    });

    // Limpeza ao descarregar a p√°gina
    window.addEventListener('beforeunload', function() {
        if (eventSource) {
            eventSource.close();
        }

        // Se usu√°rio est√° saindo (n√£o apenas atualizando), limpa sess√£o ap√≥s delay
        // Isso d√° tempo para atualiza√ß√£o da p√°gina completar
        if (!isPageVisible) {
            setTimeout(() => {
                localStorage.removeItem('sse_session');
            }, 2000);
        }
    });
</script>
{% endblock %}
